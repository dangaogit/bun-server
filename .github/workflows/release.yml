name: Create Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        default: 'v1.0.3'
      release_notes_path:
        description: 'Path to release notes file'
        required: true
        default: 'RELEASES/v1.0.3.md'
  push:
    tags:
      - 'v*.*.*'

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine tag and read release notes
        id: determine
        run: |
          set -e
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
            NOTES_FILE="${{ github.event.inputs.release_notes_path }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            NOTES_FILE="RELEASES/${TAG}.md"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          if [ -f "$NOTES_FILE" ]; then
            echo "body<<EOF" >> $GITHUB_OUTPUT
            sed 's/\r$//' "$NOTES_FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "body=${TAG} release" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.determine.outputs.tag }}
          release_name: ${{ steps.determine.outputs.tag }}
          body: ${{ steps.determine.outputs.body }}
          draft: false
          prerelease: false
