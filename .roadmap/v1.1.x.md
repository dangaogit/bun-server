# Bun Server Framework - v1.1.x Roadmap

> 目标版本：v1.1.0 - v1.1.x\
> 重点：自定义注解和拦截器机制，提供通用 AOP 支持\
> **状态**：Phase 1-4 已完成 ✅（31 个测试全部通过），Phase 5 待实现

## 🎯 v1.1.x 版本目标

v1.1.x 版本专注于**自定义注解和拦截器机制**，为框架提供通用的
AOP（面向切面编程）支持，使开发者能够轻松创建自定义注解并与 bun-server
框架无缝集成。

### 核心目标

1. **通用拦截器机制**：实现可扩展的拦截器注册和执行机制
2. **拦截器链支持**：支持多个拦截器链式调用
3. **拦截器基类**：提供拦截器基类简化开发
4. **完善文档和示例**：提供完整的自定义注解开发指南

---

## 📋 背景和评估

框架已经具备：

- ✅ **装饰器/注解基础设施**：完全支持（基于 `reflect-metadata`）
- ✅ **依赖注入容器**：完全支持
- ✅ **请求上下文**：完全支持
- ✅ **拦截器机制**：✅ **完全支持**（已实现通用拦截器机制）
- ✅ **模块化扩展**：完全支持

**已解决的问题**：

1. ✅ **拦截器集成已实现**
   - ✅ `TransactionInterceptor` 已重构为使用通用拦截器机制
   - ✅ `ControllerRegistry` 已扩展支持通用拦截器机制
   - ✅ 通过 `InterceptorRegistry` 统一管理所有拦截器

2. ✅ **拦截器链已支持**
   - ✅ 支持多个拦截器链式调用
   - ✅ 支持跨元数据键的优先级排序
   - ✅ `InterceptorChain` 实现完成

3. ✅ **拦截器基类已提供**
   - ✅ `BaseInterceptor` 抽象基类实现完成
   - ✅ 提供便捷方法简化开发
   - ✅ 内置示例拦截器（Cache、Permission）

**当前限制**：

- AOP 切面点有限：当前主要支持方法级别的拦截，不支持属性级别的拦截（未来可扩展）

---

## 🚀 v1.1.0 Roadmap

### Phase 1: 通用拦截器机制 🔴 高优先级

**目标**：实现可扩展的拦截器注册和执行机制，支持自定义注解与框架无缝集成

#### 1.1 拦截器接口定义 ✅

**实现位置**：`packages/bun-server/src/interceptor/`

- [x] **定义拦截器接口**（`types.ts`）
  - [x] `Interceptor` 接口定义
    ```typescript
    export interface Interceptor {
      execute<T>(
        target: unknown,
        propertyKey: string | symbol,
        originalMethod: (...args: unknown[]) => T | Promise<T>,
        args: unknown[],
        container: Container,
        context?: Context,
      ): Promise<T>;
    }
    ```
  - [x] `InterceptorMetadata` 类型定义
    ```typescript
    export interface InterceptorMetadata {
      metadataKey: symbol;
      interceptor: Interceptor;
      priority?: number; // 拦截器执行优先级
    }
    ```
  - [x] `INTERCEPTOR_REGISTRY_TOKEN` Symbol token

- [x] **定义拦截器注册表接口**（`interceptor-registry.ts`）
  - [x] `InterceptorRegistry` 接口定义
    ```typescript
    export interface InterceptorRegistry {
      /**
       * 注册拦截器
       * @param metadataKey - 元数据键（用于匹配装饰器）
       * @param interceptor - 拦截器实例
       * @param priority - 优先级（数字越小优先级越高）
       */
      register(
        metadataKey: symbol,
        interceptor: Interceptor,
        priority?: number,
      ): void;

      /**
       * 获取拦截器列表（按优先级排序）
       * @param metadataKey - 元数据键
       * @returns 拦截器列表
       */
      getInterceptors(metadataKey: symbol): Interceptor[];

      /**
       * 检查是否有拦截器
       * @param metadataKey - 元数据键
       * @returns 是否有拦截器
       */
      hasInterceptor(metadataKey: symbol): boolean;

      /**
       * 清除所有拦截器
       */
      clear(): void;
    }
    ```

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 1.2 拦截器注册表实现 ✅

**实现位置**：`packages/bun-server/src/interceptor/interceptor-registry.ts`

- [x] **实现 InterceptorRegistry 类**
  - [x] 拦截器存储（使用 `Map<symbol, InterceptorMetadata[]>`）
  - [x] 拦截器注册逻辑
  - [x] 拦截器查询逻辑（按优先级排序）
  - [x] 拦截器清除逻辑

- [x] **集成到 DI 容器**
  - [x] 注册 `InterceptorRegistry` 为单例
  - [x] 提供 `INTERCEPTOR_REGISTRY_TOKEN` token
  - [x] 支持通过 `@Inject()` 注入

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 1.3 ControllerRegistry 集成 ✅

**实现位置**：`packages/bun-server/src/controller/controller.ts`

- [x] **扩展 ControllerRegistry 支持拦截器**
  - [x] 注入 `InterceptorRegistry`（通过构造函数或容器）
  - [x] 在路由处理器创建时检查所有注册的拦截器
  - [x] 按优先级顺序执行拦截器链
  - [x] 移除硬编码的 `TransactionInterceptor` 逻辑

- [ ] **拦截器执行逻辑**
  ```typescript
  // 伪代码示例
  const handler = async (context: Context): Promise<Response> => {
    const controllerInstance = container.resolve(controllerClass);
    const method = controllerInstance[propertyKey];

    // 获取所有拦截器（按优先级排序）
    const interceptors = interceptorRegistry.getAllInterceptors(
      prototype,
      propertyKey,
    );

    // 构建拦截器链
    let result: unknown;
    if (interceptors.length > 0) {
      // 执行拦截器链
      result = await executeInterceptorChain(
        interceptors,
        prototype,
        propertyKey,
        method,
        params,
        container,
        context,
      );
    } else {
      // 没有拦截器，直接执行
      result = method.apply(controllerInstance, params);
    }

    return context.createResponse(result);
  };
  ```

- [x] **保持向后兼容**
  - [x] `TransactionInterceptor` 通过注册表注册，而不是硬编码
  - [x] 现有功能不受影响

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

---

### Phase 2: 拦截器链支持 🔴 高优先级

**目标**：支持多个拦截器链式调用，实现复杂的 AOP 场景

#### 2.1 拦截器链执行器 ✅

**实现位置**：`packages/bun-server/src/interceptor/interceptor-chain.ts`

- [x] **实现拦截器链执行器**
  - [x] `InterceptorChain` 类定义
  - [x] 链式执行逻辑（按优先级顺序）
  - [x] 支持前置处理、后置处理、错误处理
  - [x] 支持中断链式执行（抛出异常）

- [ ] **拦截器链执行模式**
  ```typescript
  // 伪代码示例
  async function executeInterceptorChain(
    interceptors: Interceptor[],
    target: unknown,
    propertyKey: string | symbol,
    originalMethod: Function,
    args: unknown[],
    container: Container,
    context?: Context,
  ): Promise<unknown> {
    // 按优先级排序
    const sortedInterceptors = interceptors.sort((a, b) =>
      a.priority - b.priority
    );

    // 构建执行链
    let index = 0;
    const next = async (): Promise<unknown> => {
      if (index >= sortedInterceptors.length) {
        // 所有拦截器执行完毕，执行原方法
        return await Promise.resolve(originalMethod.apply(target, args));
      }

      const interceptor = sortedInterceptors[index++];
      return await interceptor.execute(
        target,
        propertyKey,
        async (...args) => await next(), // 下一个拦截器或原方法
        args,
        container,
        context,
      );
    };

    return await next();
  }
  ```

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

#### 2.2 多拦截器元数据支持 ✅

**实现位置**：`packages/bun-server/src/interceptor/metadata.ts`

- [x] **支持方法上多个装饰器**
  - [x] 扫描方法上的所有元数据键
  - [x] 收集所有匹配的拦截器
  - [x] 合并并排序拦截器列表

- [ ] **元数据扫描工具**
  ```typescript
  /**
   * 扫描方法上的所有拦截器元数据
   */
  export function scanInterceptorMetadata(
    target: unknown,
    propertyKey: string | symbol,
    registry: InterceptorRegistry,
  ): Interceptor[] {
    const interceptors: Interceptor[] = [];

    // 扫描所有已注册的元数据键
    for (const [metadataKey] of registry.getAllMetadataKeys()) {
      const metadata = Reflect.getMetadata(metadataKey, target, propertyKey);
      if (metadata) {
        const matchedInterceptors = registry.getInterceptors(metadataKey);
        interceptors.push(...matchedInterceptors);
      }
    }

    // 按优先级排序
    return interceptors.sort((a, b) => (a.priority ?? 0) - (b.priority ?? 0));
  }
  ```

**优先级**：🔴 高\
**预计完成时间**：v1.1.0

---

### Phase 3: 拦截器基类 🟡 中优先级

**目标**：提供拦截器基类简化自定义拦截器开发

#### 3.1 拦截器基类实现 ✅

**实现位置**：`packages/bun-server/src/interceptor/base-interceptor.ts`

- [x] **实现 BaseInterceptor 抽象类**
  ```typescript
  export abstract class BaseInterceptor implements Interceptor {
    /**
     * 执行拦截器逻辑
     */
    public abstract execute<T>(
      target: unknown,
      propertyKey: string | symbol,
      originalMethod: (...args: unknown[]) => T | Promise<T>,
      args: unknown[],
      container: Container,
      context?: Context,
    ): Promise<T>;

    /**
     * 前置处理（可选）
     */
    protected async before(
      target: unknown,
      propertyKey: string | symbol,
      args: unknown[],
      container: Container,
      context?: Context,
    ): Promise<void> {
      // 默认空实现，子类可覆盖
    }

    /**
     * 后置处理（可选）
     */
    protected async after(
      target: unknown,
      propertyKey: string | symbol,
      result: unknown,
      container: Container,
      context?: Context,
    ): Promise<unknown> {
      // 默认返回原结果，子类可覆盖
      return result;
    }

    /**
     * 错误处理（可选）
     */
    protected async onError(
      target: unknown,
      propertyKey: string | symbol,
      error: unknown,
      container: Container,
      context?: Context,
    ): Promise<never> {
      // 默认重新抛出错误，子类可覆盖
      throw error;
    }
  }
  ```

- [x] **提供便捷方法**
  - [x] `getMetadata()` - 获取元数据
  - [x] `resolveService()` - 从容器解析服务
  - [x] `getHeader()` - 从上下文获取请求头
  - [x] `getQuery()` - 从上下文获取查询参数
  - [x] `getParam()` - 从上下文获取路径参数

**优先级**：🟡 中\
**预计完成时间**：v1.1.1 ✅

#### 3.2 常用拦截器示例 ✅

**实现位置**：`packages/bun-server/src/interceptor/builtin/`

- [x] **缓存拦截器示例**（`cache-interceptor.ts`）
  - [x] 展示如何使用 `BaseInterceptor`
  - [x] 实现缓存逻辑
  - [x] 提供完整示例代码
  - [x] 测试覆盖（4 个测试全部通过）

- [x] **权限拦截器示例**（`permission-interceptor.ts`）
  - [x] 展示如何访问容器和上下文
  - [x] 实现权限检查逻辑
  - [x] 提供完整示例代码
  - [x] 测试覆盖（5 个测试全部通过）

**优先级**：🟡 中\
**预计完成时间**：v1.1.1

---

### Phase 4: TransactionInterceptor 重构 🟡 中优先级

**目标**：将现有的 `TransactionInterceptor` 重构为使用新的拦截器机制

#### 4.1 TransactionInterceptor 重构 ✅

**实现位置**：`packages/bun-server/src/database/orm/transaction-interceptor.ts`

- [x] **重构 TransactionInterceptor**
  - [x] 实现 `Interceptor` 接口
  - [x] 移除硬编码的集成逻辑
  - [x] 通过 `InterceptorRegistry` 注册
  - [x] 保留静态方法 `executeWithTransaction` 用于向后兼容

- [x] **注册 TransactionInterceptor**
  - [x] 在 `DatabaseExtension` 中注册拦截器
  - [x] 使用 `TRANSACTION_METADATA_KEY` 作为元数据键
  - [x] 设置优先级为 50（确保在其他业务拦截器之前执行）

- [x] **移除 ControllerRegistry 中的硬编码**
  - [x] 移除 `TransactionInterceptor` 的硬编码调用
  - [x] 确保通过拦截器机制执行
  - [x] 向后兼容性测试通过（6 个测试全部通过）

**优先级**：🟡 中\
**预计完成时间**：v1.1.1

---

### Phase 5: 文档和示例 🟢 低优先级

**目标**：提供完整的自定义注解开发指南和示例

#### 5.1 开发文档

- [ ] **自定义注解开发指南**（`docs/custom-decorators.md`）
  - [ ] 装饰器开发规范
  - [ ] 拦截器开发规范
  - [ ] 元数据系统使用指南
  - [ ] 容器和上下文访问指南

- [ ] **API 文档更新**
  - [ ] `Interceptor` 接口文档
  - [ ] `InterceptorRegistry` 接口文档
  - [ ] `BaseInterceptor` 类文档
  - [ ] 拦截器链执行机制文档

**优先级**：🟢 低\
**预计完成时间**：v1.1.2

#### 5.2 示例代码

- [ ] **基础示例**（`examples/custom-decorator-app.ts`）
  - [ ] 创建自定义装饰器
  - [ ] 实现拦截器
  - [ ] 注册和使用

- [ ] **高级示例**（`examples/advanced-decorator-app.ts`）
  - [ ] 多个拦截器链式调用
  - [ ] 访问容器和上下文
  - [ ] 错误处理

- [ ] **实际应用示例**
  - [ ] 缓存装饰器示例
  - [ ] 权限装饰器示例
  - [ ] 日志装饰器示例

**优先级**：🟢 低\
**预计完成时间**：v1.1.2

---

## 📦 模块结构规划

### 新增模块结构 ✅

```
packages/bun-server/src/
├── interceptor/
│   ├── types.ts                    ✅ 拦截器接口和类型定义
│   ├── interceptor-registry.ts     ✅ 拦截器注册表实现
│   ├── interceptor-chain.ts        ✅ 拦截器链执行器
│   ├── metadata.ts                 ✅ 元数据扫描工具
│   ├── base-interceptor.ts         ✅ 拦截器基类
│   ├── builtin/                    ✅ 内置拦截器示例
│   │   ├── cache-interceptor.ts    ✅ 缓存拦截器
│   │   ├── permission-interceptor.ts ✅ 权限拦截器
│   │   └── index.ts                ✅ 模块导出
│   └── index.ts                    ✅ 模块导出
```

### 集成点 ✅

1. ✅ **ControllerRegistry**：在路由处理器创建时集成拦截器机制
2. ✅ **DI 容器**：注册 `InterceptorRegistry` 为单例服务（在 Application
   构造函数中）
3. ✅ **DatabaseExtension**：注册 `TransactionInterceptor` 到拦截器注册表

---

## 🎯 v1.1.0 发布标准

### 功能完整性 ✅

- [x] **拦截器机制核心功能**
  - [x] `Interceptor` 接口定义完成
  - [x] `InterceptorRegistry` 实现完成
  - [x] `ControllerRegistry` 集成完成
  - [x] 拦截器链执行机制完成

- [x] **向后兼容**
  - [x] `TransactionInterceptor` 重构完成
  - [x] 现有功能不受影响
  - [x] 现有测试全部通过（TransactionInterceptor: 6 个测试，Controller: 6
        个测试）

### 稳定性 ✅

- [x] **单元测试**
  - [x] `InterceptorRegistry` 单元测试（10 个测试全部通过）
  - [x] `InterceptorChain` 单元测试（7 个测试全部通过）
  - [x] `BaseInterceptor` 基类实现完成
  - [x] 集成测试（5 个测试全部通过）
  - [x] 缓存拦截器测试（4 个测试全部通过）
  - [x] 权限拦截器测试（5 个测试全部通过）
  - [x] **总计：31 个测试全部通过**

- [ ] **性能测试**
  - [ ] 拦截器执行性能测试
  - [ ] 拦截器链执行性能测试
  - [ ] 与直接方法调用性能对比

- [x] **无已知严重 Bug**

### 文档

- [ ] **开发文档**
  - [ ] 自定义注解开发指南
  - [ ] 拦截器开发指南
  - [ ] API 文档更新

- [ ] **示例代码**
  - [ ] 基础示例
  - [ ] 高级示例
  - [ ] 实际应用示例

---

## 📝 实现注意事项

### 1. 向后兼容性

- **重要**：确保现有功能不受影响
- `TransactionInterceptor` 重构后功能保持一致
- 现有测试全部通过

### 2. 性能考虑

- **拦截器执行开销**：最小化拦截器执行开销
- **拦截器链优化**：优化拦截器链执行逻辑
- **缓存机制**：考虑缓存拦截器查找结果

### 3. 错误处理

- **拦截器错误**：定义统一的错误类型
- **链式执行错误**：支持错误传播和中断
- **错误恢复**：提供错误恢复机制

### 4. 扩展性

- **接口设计**：接口设计要考虑未来扩展
- **插件机制**：支持通过插件注册拦截器
- **动态注册**：支持运行时动态注册拦截器

### 5. 类型安全

- **TypeScript 支持**：充分利用 TypeScript 类型系统
- **泛型支持**：支持泛型拦截器
- **类型推断**：提供良好的类型推断

---

## 📊 实施进度总结

### Phase 1-4 完成情况

- ✅ **Phase 1: 通用拦截器机制** - 100% 完成
  - ✅ 1.1 拦截器接口定义
  - ✅ 1.2 拦截器注册表实现
  - ✅ 1.3 ControllerRegistry 集成

- ✅ **Phase 2: 拦截器链支持** - 100% 完成
  - ✅ 2.1 拦截器链执行器
  - ✅ 2.2 多拦截器元数据支持

- ✅ **Phase 3: 拦截器基类和示例** - 100% 完成
  - ✅ 3.1 拦截器基类实现
  - ✅ 3.2 常用拦截器示例（Cache、Permission）

- ✅ **Phase 4: TransactionInterceptor 重构** - 100% 完成
  - ✅ 4.1 TransactionInterceptor 重构
  - ✅ 通过 DatabaseExtension 自动注册

- ⏳ **Phase 5: 文档和示例** - 待实现（低优先级）

### 测试覆盖 ✅

- ✅ **31 个拦截器测试全部通过**
  - InterceptorRegistry: 10 个测试
  - InterceptorChain: 7 个测试
  - 集成测试: 5 个测试
  - CacheInterceptor: 4 个测试
  - PermissionInterceptor: 5 个测试

- ✅ **向后兼容性测试通过**
  - TransactionInterceptor: 6 个测试
  - Controller 集成: 6 个测试

### 代码统计

- **新增文件**: 11 个核心文件 + 5 个测试文件
- **修改文件**: 5 个（Application、ControllerRegistry、DatabaseExtension 等）
- **代码行数**: 约 1500+ 行
- **测试覆盖**: 31 个测试，100% 通过

### 核心功能

✅ **已完成的核心功能**：

1. 通用拦截器机制（InterceptorRegistry）
2. 拦截器链支持（InterceptorChain）
3. 拦截器基类（BaseInterceptor）
4. 内置示例拦截器（Cache、Permission）
5. TransactionInterceptor 重构
6. 完整的测试覆盖

---

## 🔗 相关资源

- [v1.2.x Roadmap](./v1.2.x.md) - 微服务架构支持（已滞后）
- [v1.x.x 汇总清单](./v1.x.x.md)
- [扩展系统文档](../docs/extensions.md)
